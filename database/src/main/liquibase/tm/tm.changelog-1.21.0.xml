<?xml version="1.0" encoding="UTF-8"?>
<!--

        This file is part of the Squashtest platform.
        Copyright (C) Henix, henix.fr

        See the NOTICE file distributed with this work for additional
        information regarding copyright ownership.

        This is free software: you can redistribute it and/or modify
        it under the terms of the GNU Lesser General Public License as published by
        the Free Software Foundation, either version 3 of the License, or
        (at your option) any later version.

        this software is distributed in the hope that it will be useful,
        but WITHOUT ANY WARRANTY; without even the implied warranty of
        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
        GNU Lesser General Public License for more details.

        You should have received a copy of the GNU Lesser General Public License
        along with this software.  If not, see <http://www.gnu.org/licenses/>.

-->
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">


  <changeSet id="tm-1.21.0" author="jprioux">
    <comment>Update TM database version number</comment>
    <update tableName="CORE_CONFIG">
      <column name="VALUE" value="1.21.0"/>
      <where>STR_KEY = 'squashtest.tm.database.version'</where>
    </update>
  </changeSet>

  <changeSet id="tm-1.21.0-TM-244-remote-automation-request-extender" author="jlor">

    <comment>Create new table for RemoteAutomationRequestExtender</comment>

    <createTable tableName="REMOTE_AUTOMATION_REQUEST_EXTENDER">

      <column name="REMOTE_AUTOMATION_REQUEST_EXTENDER_ID" type="BIGINT" autoIncrement="true" remarks="The auto-generated id">
        <constraints primaryKey="true" nullable="false" />
      </column>

      <column name="AUTOMATION_REQUEST_ID" type="BIGINT" remarks="The automation request this extender extends">
        <constraints nullable="false" foreignKeyName="fk_remote_automation_request_extender_automation_request_id" references="AUTOMATION_REQUEST (AUTOMATION_REQUEST_ID)" />
      </column>

      <column name="SERVER_ID" type="BIGINT" remarks="The bugtracker to which the automation request is linked">
        <constraints nullable="true" foreignKeyName="fk_remote_automation_request_extender_server_id" references="BUGTRACKER (BUGTRACKER_ID)" />
      </column>

      <column name="REMOTE_STATUS" type="VARCHAR(255)" remarks="The remote status as defined in the bugtracker">
        <constraints nullable="true" />
      </column>

      <column name="REMOTE_ISSUE_KEY" type="VARCHAR(255)" remarks="The remote issue key as generated by Jira">
        <constraints nullable="false" />
      </column>

      <column name="REMOTE_REQUEST_URL" type="VARCHAR(300)" remarks="The Url to the remote request">
        <constraints nullable="true" />
      </column>

      <column name="REMOTE_ASSIGNED_TO" type="VARCHAR(300)" remarks="email of the assigned">
        <constraints nullable="false" />
      </column>


    </createTable>

    <createIndex tableName="REMOTE_AUTOMATION_REQUEST_EXTENDER" indexName="idx_fk_remote_automation_request_extender_automation_request_id">
      <column name="AUTOMATION_REQUEST_ID" />
    </createIndex>

    <createIndex tableName="REMOTE_AUTOMATION_REQUEST_EXTENDER" indexName="idx_fk_remote_automation_request_extender_server_id">
      <column name="SERVER_ID" />
    </createIndex>

  </changeSet>

  <changeSet id="tm-1.21.0-TM-248-automation-workflow-type" author="jlor">

    <comment>Modify column ALLOW_AUTOMATION_WORKFLOW into AUTOMATION_WORKFLOW_TYPE</comment>

    <addColumn tableName="PROJECT">
      <column name="AUTOMATION_WORKFLOW_TYPE" type="VARCHAR(25)" defaultValue="NONE" remarks="This column precises which workflow type is used.">
        <constraints nullable="false" />
      </column>
    </addColumn>

    <sql>
      update PROJECT
      set AUTOMATION_WORKFLOW_TYPE =
      case
      when ALLOW_AUTOMATION_WORKFLOW = true then 'NATIVE'
      else 'NONE'
      end;
    </sql>

  </changeSet>

  <changeSet id="tm-1.21.0-TM-248-plugin-type" author="amk">

    <comment>add new column PLUGIN_TYPE into LIBRARY_PLUGIN_BINDING</comment>

    <addColumn tableName="LIBRARY_PLUGIN_BINDING">
      <column name="PLUGIN_TYPE" type="VARCHAR(25)"  remarks="This column specifies which type of plugin is used. for now only one type used: Automation.">
        <constraints nullable="true" />
      </column>
    </addColumn>

  </changeSet>
  
    <changeSet id="tm-1.21.0-TM-211-active" author="amk">

    <comment>add new column ACTIVE into LIBRARY_PLUGIN_BINDING</comment>

    <addColumn tableName="LIBRARY_PLUGIN_BINDING">
      <column name="ACTIVE" type="BOOLEAN"  remarks="This column specifies if plugin is enable or disable for a project ." defaultValueBoolean="true">
      </column>
    </addColumn>

  </changeSet>

  <changeSet id="tm-1.21.0-TM-649-sync-enable" author="api">
    <comment> add new column Sync_Enable into REMOTE_SYNCHONISATION </comment>

    <addColumn tableName="REMOTE_SYNCHRONISATION">
      <column name="SYNC_ENABLE" type="BOOLEAN" remarks="This column specifies if synchronisation is enable or disable for a project" defaultValueBoolean="true">
        <constraints nullable="false"/>
      </column>
    </addColumn>
  </changeSet>

  <changeSet id="tm-1.21.0-test-case-script-type" author="jlor">
    <comment>Add a new column TC_SCRIPT_TYPE</comment>
    <addColumn tableName="PROJECT">
      <column name="TC_SCRIPT_TYPE" type="VARCHAR(25)" defaultValue="GHERKIN" remarks="This column specifies the type of scripted test cases used in the project">
        <constraints nullable="false"/>
      </column>
    </addColumn>
  </changeSet>

  <changeSet id="tm-1.21.0-rename-can_run_gherkin-column" author="jlor">
    <comment>Rename CAN_RUN_GHERKIN column to CAN_RUN_SCRIPT</comment>
    <renameColumn tableName="TEST_AUTOMATION_PROJECT" oldColumnName="CAN_RUN_GHERKIN" newColumnName="CAN_RUN_SCRIPT" columnDataType="BOOLEAN" />
  </changeSet>

  <changeSet id="tm-1.21.0-TM-211-last-sync-date" author="amk">

    <comment>add new column LAST-SYNC-DATE into REMOTE_AUTOMATION_REQUEST_EXTENDER</comment>

    <addColumn tableName="REMOTE_AUTOMATION_REQUEST_EXTENDER">
      <column name="LAST_SYNC_DATE" type="DATETIME" defaultValue="NULL"  remarks="Date of the last synchronisation." >
      </column>
    </addColumn>

  </changeSet>

  <changeSet id="tm-1.21.0-TM-725-add-committer-mail-in-scm-server" author="jlor">
    <comment>Add column COMMITTER_MAIL in SCM_SERVER</comment>

    <addColumn tableName="SCM_SERVER">
      <column name="COMMITTER_MAIL" type="VARCHAR(255)" defaultValue="">
        <constraints nullable="false" />
      </column>
    </addColumn>

  </changeSet>

</databaseChangeLog>
