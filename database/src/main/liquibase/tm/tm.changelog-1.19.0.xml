<?xml version="1.0" encoding="UTF-8"?>
<!--

        This file is part of the Squashtest platform.
        Copyright (C) Henix, henix.fr

        See the NOTICE file distributed with this work for additional
        information regarding copyright ownership.

        This is free software: you can redistribute it and/or modify
        it under the terms of the GNU Lesser General Public License as published by
        the Free Software Foundation, either version 3 of the License, or
        (at your option) any later version.

        this software is distributed in the hope that it will be useful,
        but WITHOUT ANY WARRANTY; without even the implied warranty of
        MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
        GNU Lesser General Public License for more details.

        You should have received a copy of the GNU Lesser General Public License
        along with this software.  If not, see <http://www.gnu.org/licenses/>.

-->
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">


  <changeSet id="tm-1.19.0" author="cholc">
    <comment>Update TM database version number</comment>
    <update tableName="CORE_CONFIG">
      <column name="VALUE" value="1.19.0"/>
      <where>STR_KEY = 'squashtest.tm.database.version'</where>
    </update>
  </changeSet>

  <changeSet id="tm-1.19.0-SQTM-400-info-list-item" author="cholc">
    <comment>Adds a colour field to info list items</comment>
    <addColumn tableName="INFO_LIST_ITEM">
      <column name="COLOUR" type="VARCHAR(7)">
        <constraints nullable="true"/>
      </column>
    </addColumn>
  </changeSet>

  <changeSet id="tm-1.19.0-SQTM-400-custom-field-option" author="cholc">
    <comment>Adds a colour field to custom field options</comment>
    <addColumn tableName="CUSTOM_FIELD_OPTION">
      <column name="COLOUR" type="VARCHAR(7)">
        <constraints nullable="true"/>
      </column>
    </addColumn>
  </changeSet>

  <changeSet id="tm-1.19.0-SQTM-400-custom-field-value" author="cholc">
    <comment>Stores the colour of the selected custom field option, so it can be displayed in a chart later</comment>
    <addColumn tableName="CUSTOM_FIELD_VALUE">
      <column name="COLOUR" type="VARCHAR(7)">
        <constraints nullable="true"/>
      </column>
    </addColumn>
  </changeSet>

  <changeSet id="tm-1.19.0-SQTM-400-custom-field" author="cholc">
    <comment>Stores the default colour of the custom field, needed to create an entity with a default CUF of type list</comment>
    <addColumn tableName="CUSTOM_FIELD">
      <column name="DEFAULT_COLOUR" type="VARCHAR(7)">
        <constraints nullable="true"/>
      </column>
    </addColumn>
  </changeSet>

  <changeSet id="tm-1.19.0-SQTM-409-iteration-test-suite-remove-constraint" author="cholc">
    <comment>To drop an unique constraint, you need the constraint's name, which we don't have, so here we copy the column and delete the original</comment>

    <addColumn tableName="ITERATION_TEST_SUITE">
      <column name="TEST_SUITE_ID_TEMP" type="BIGINT">
        <constraints nullable="true" unique="false" />
      </column>
    </addColumn>

    <dropForeignKeyConstraint baseTableName="ITERATION_TEST_SUITE" constraintName="fk_iteration_test_suite_suite"/>

    <update tableName="ITERATION_TEST_SUITE">
      <column name="TEST_SUITE_ID_TEMP" type="BIGINT" valueComputed="TEST_SUITE_ID"/>
    </update>

    <dropColumn columnName="TEST_SUITE_ID" tableName="ITERATION_TEST_SUITE"/>

    <renameColumn columnDataType="BIGINT" newColumnName="TEST_SUITE_ID" oldColumnName="TEST_SUITE_ID_TEMP" tableName="ITERATION_TEST_SUITE"/>

    <addNotNullConstraint tableName="ITERATION_TEST_SUITE" columnName="TEST_SUITE_ID" columnDataType="BIGINT"/>

    <addForeignKeyConstraint baseColumnNames="TEST_SUITE_ID"
                             baseTableName="ITERATION_TEST_SUITE"
                             constraintName="fk_iteration_test_suite_suite"
                             referencedColumnNames="ID"
                             referencedTableName="TEST_SUITE"/>
  </changeSet>

  <changeSet id="tm-1.19.0-SQTM-409-iteration-test-suite-order" author="cholc">
    <comment>add an order to iterations' test suites</comment>
    <addColumn tableName="ITERATION_TEST_SUITE">
      <column name="ITERATION_TEST_SUITE_ORDER" type="INT">
      </column>
    </addColumn>
  </changeSet>

  <changeSet id="tm-1.19.0-SQTM-409-iteration-test-suite-order-generation" author="cholc">
    <comment>will compute the order of the test suites in the iterations, should work for all databases</comment>
    <sql>
      UPDATE ITERATION_TEST_SUITE ITS
      SET
          ITERATION_TEST_SUITE_ORDER = (SELECT
                  SUB_QUERY.ORDER_DEF
              FROM
                  (SELECT
                      ITS1.ITERATION_ID AS I_ID,
                      ITS1.TEST_SUITE_ID AS TS_ID,
                      (COUNT(*) - 1) AS ORDER_DEF
                  FROM
                      ITERATION_TEST_SUITE ITS1
                  INNER JOIN ITERATION_TEST_SUITE ITS2 ON ITS1.ITERATION_ID = ITS2.ITERATION_ID
                      AND ITS1.TEST_SUITE_ID >= ITS2.TEST_SUITE_ID
                   GROUP BY ITS1.ITERATION_ID , ITS1.TEST_SUITE_ID) AS SUB_QUERY
              WHERE
                  SUB_QUERY.I_ID = ITS.ITERATION_ID
                  AND SUB_QUERY.TS_ID = ITS.TEST_SUITE_ID);
    </sql>
    <addUniqueConstraint tableName="ITERATION_TEST_SUITE" columnNames="ITERATION_ID, ITERATION_TEST_SUITE_ORDER"
                         constraintName="uc_iteration_iteration_test_suite_order"/>
    <addNotNullConstraint tableName="ITERATION_TEST_SUITE" columnName="ITERATION_TEST_SUITE_ORDER" columnDataType="INT"/>
  </changeSet>

  <changeSet id="tm-1.19.0-SQTM-399-infolist-items-default-colours" author="cholc">
    <comment>Requirement categories colours</comment>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#C3AB77"/>
      <where>CODE = 'CAT_TEST_REQUIREMENT'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#CDCDCD"/>
      <where>CODE = 'CAT_UNDEFINED'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#8F6057"/>
      <where>CODE = 'CAT_ERGONOMIC'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#FCCA46"/>
      <where>CODE = 'CAT_PERFORMANCE'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#233D4D"/>
      <where>CODE = 'CAT_TECHNICAL'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#094C75"/>
      <where>CODE = 'CAT_USER_STORY'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#FE7F2D"/>
      <where>CODE = 'CAT_SECURITY'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#7594CD"/>
      <where>CODE = 'CAT_FUNCTIONAL'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#BB5759"/>
      <where>CODE = 'CAT_NON_FUNCTIONAL'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#A1C181"/>
      <where>CODE = 'CAT_USE_CASE'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#619B8A"/>
      <where>CODE = 'CAT_BUSINESS'</where>
    </update>

    <comment>Test cases natures colours</comment>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#A1C181"/>
      <where>CODE = 'NAT_USER_TESTING'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#FCCA46"/>
      <where>CODE = 'NAT_PERFORMANCE_TESTING'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#FE7F2D"/>
      <where>CODE = 'NAT_SECURITY_TESTING'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#233D4D"/>
      <where>CODE = 'NAT_ATDD'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#CDCDCD"/>
      <where>CODE = 'NAT_UNDEFINED'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#7594CD"/>
      <where>CODE = 'NAT_FUNCTIONAL_TESTING'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#BB5759"/>
      <where>CODE = 'NAT_NON_FUNCTIONAL_TESTING'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#619B8A"/>
      <where>CODE = 'NAT_BUSINESS_TESTING'</where>
    </update>

    <comment>Test cases types colours</comment>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#CDCDCD"/>
      <where>CODE = 'TYP_UNDEFINED'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#5B9367"/>
      <where>CODE = 'TYP_COMPLIANCE_TESTING'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#CD533B"/>
      <where>CODE = 'TYP_CORRECTION_TESTING'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#D8A86E"/>
      <where>CODE = 'TYP_EVOLUTION_TESTING'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#F2E77E"/>
      <where>CODE = 'TYP_REGRESSION_TESTING'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#2D5635"/>
      <where>CODE = 'TYP_END_TO_END_TESTING'</where>
    </update>

    <update tableName="INFO_LIST_ITEM">
      <column name="COLOUR" value="#F2E2CE"/>
      <where>CODE = 'TYP_PARTNER_TESTING'</where>
    </update>
  </changeSet>

</databaseChangeLog>
